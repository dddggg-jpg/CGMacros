<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CGMacros Viewer</title>

  <!-- Chart.js and Plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    #chartContainer {
      width: 100%;
      max-width: 900px;
      height: 400px;
    }
    button {
      margin-top: 10px;
      padding: 5px 10px;
      cursor: pointer;
    }
    #bioSummary {
      margin-bottom: 20px;
      background: #f7f7f7;
      padding: 10px;
      border-radius: 6px;
      max-width: 900px;
    }
  </style>
</head>

<body>
  <h2>CGMacros Viewer</h2>

  <!-- Participant selector and control bar -->
  <div style="margin-bottom: 10px;">
    <label for="participantSelect"><strong>Participant:</strong></label>
    <select id="participantSelect">
  <option value="001">001</option>
  <option value="002">002</option>
  <option value="003">003</option>
  <option value="004">004</option>
  <option value="005">005</option>
  <option value="006">006</option>
  <option value="007">007</option>
  <option value="008">008</option>
  <option value="009">009</option>
  <option value="010">010</option>
  <option value="011">011</option>
  <option value="012">012</option>
  <option value="013">013</option>
  <option value="014">014</option>
  <option value="015">015</option>
  <option value="016">016</option>
  <option value="017">017</option>
  <option value="018">018</option>
  <option value="019">019</option>
  <option value="020">020</option>
  <option value="021">021</option>
  <option value="022">022</option>
  <option value="023">023</option>
  <option value="026">026</option>
  <option value="027">027</option>
  <option value="028">028</option>
  <option value="029">029</option>
  <option value="030">030</option>
  <option value="031">031</option>
  <option value="032">032</option>
  <option value="033">033</option>
  <option value="034">034</option>
  <option value="035">035</option>
  <option value="036">036</option>
  <option value="038">038</option>
  <option value="039">039</option>
  <option value="041">041</option>
  <option value="042">042</option>
  <option value="043">043</option>
  <option value="044">044</option>
  <option value="045">045</option>
  <option value="046">046</option>
  <option value="047">047</option>
  <option value="048">048</option>
  <option value="049">049</option>
</select>

    <button id="resetZoomBtn">Reset Zoom</button>
  </div>

  <!-- Bio summary panel -->
  <div id="bioSummary">
    <strong>Participant 001:</strong> Loading demographics...
  </div>

  <!-- Chart container -->
  <div id="chartContainer">
    <canvas id="cgmChart"></canvas>
  </div>

  <footer style="margin-top:40px; font-size:0.9em; max-width:900px; color:#333;">
    <h3>Dataset Citation</h3>
    <p>
      Gutierrez-Osuna, R., Kerr, D., Mortazavi, B., & Das, A. (2025).
      <em>CGMacros: a scientific dataset for personalized nutrition and diet monitoring</em> (v1.0.0).
      PhysioNet. RRID: SCR_007345.
      <a href="https://doi.org/10.13026/3z8q-x658" target="_blank">https://doi.org/10.13026/3z8q-x658</a>
    </p>
    <p>
      Anurag Das, David Kerr, Namino Glanz, Wendy Bevier, Rony Santiago, Ricardo Gutierrez-Osuna, and Bobak Mortazavi.
      "<em>CGMacros: a scientific dataset for personalized nutrition and diet monitoring.</em>"
      <em>Scientific Data</em> (under review).
    </p>
    <p>
      Goldberger A., Amaral L., Glass L., Hausdorff J., Ivanov P. C., Mark R., … & Stanley H. E. (2000).
      <em>PhysioBank, PhysioToolkit, and PhysioNet: Components of a new research resource for complex physiologic signals.</em>
      <em>Circulation</em> 101 (23): e215–e220. RRID: SCR_007345.
    </p>
    <p>
      <strong>License:</strong> Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)
    </p>
  </footer>

  <script>
    const biosFile = 'bio.csv';  // bios data file
    let biosData = {};
    let chart;

    // Load bios file once, then initialize participant selector
    Papa.parse(biosFile, {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function(results) {
        results.data.forEach(row => {
          if (row.subject) biosData[row.subject] = row;
        });
        initChart();
      }
    });

    function initChart() {
      const select = document.getElementById('participantSelect');
      loadParticipant(select.value);
      select.addEventListener('change', e => loadParticipant(e.target.value));

      document.getElementById('resetZoomBtn').addEventListener('click', () => {
        if (chart) chart.resetZoom();
      });
    }

    function loadParticipant(num) {
      const file = `CGMacros-${num}.csv`;
      const bio = biosData[num];
      updateBioSummary(num, bio);

      Papa.parse(file, {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(results) {
          const data = results.data;
          plotCGM(data);
        }
      });
    }

    function updateBioSummary(num, bio) {
      const div = document.getElementById('bioSummary');
      if (!bio) {
        div.innerHTML = `<strong>Participant ${num}:</strong> Bio not found.`;
        return;
      }
      const category = bio["A1c PDL (Lab)"] >= 6.5 ? "Type 2 Diabetes" :
                       bio["A1c PDL (Lab)"] >= 5.7 ? "Prediabetes" : "Healthy";

      div.innerHTML = `
        <strong>Participant ${String(num).padStart(3, '0')}:</strong>
        ${bio.Gender}, ${bio.Age} yrs |
        BMI ${bio.BMI.toFixed(1)} |
        A1c ${bio["A1c PDL (Lab)"]}% (${category})<br>
        Fasting Glucose: ${bio["Fasting GLU - PDL (Lab)"]} mg/dL |
        Triglycerides: ${bio.Triglycerides} mg/dL |
        HDL: ${bio.HDL} mg/dL |
        LDL: ${bio["LDL (Cal)"]} mg/dL
      `;
    }

    function plotCGM(data) {
      const timeCol = 'Timestamp';
      const libreCol = 'Libre GL';
      const dexCol = 'Dexcom GL';
      const times = [];
      const libreVals = [];
      const dexVals = [];

      data.forEach(row => {
        if (row[timeCol]) {
          times.push(row[timeCol]);
          libreVals.push(row[libreCol] || null);
          dexVals.push(row[dexCol] || null);
        }
      });

      if (chart) chart.destroy(); // Clear previous chart

      const ctx = document.getElementById('cgmChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: times,
          datasets: [
            {
              label: 'Libre CGM',
              data: libreVals,
              borderColor: 'rgb(255, 99, 132)',
              fill: false,
              spanGaps: true,
              pointRadius: 0
            },
            {
              label: 'Dexcom CGM',
              data: dexVals,
              borderColor: 'rgb(54, 162, 235)',
              fill: false,
              spanGaps: true,
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: 'Time' },
              ticks: { maxTicksLimit: 10 }
            },
            y: {
              title: { display: true, text: 'Glucose (mg/dL)' },
              suggestedMin: 60,
              suggestedMax: 200
            }
          },
          plugins: {
            title: { display: true, text: 'Libre vs. Dexcom CGM' },
            legend: { position: 'bottom' },
            zoom: {
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                mode: 'x'
              },
              pan: { enabled: true, mode: 'x' }
            }
          }
        }
      });
    }
  </script>
</body>
</html>

