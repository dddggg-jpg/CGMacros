<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CGMacros Participants</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      color: #333;
    }
    h1 {
      margin-bottom: 10px;
    }
    p.description {
      max-width: 900px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 900px;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 10px;
      text-align: left;
    }
    thead {
      background: #f2f2f2;
    }
    tr:nth-child(even) {
      background: #fafafa;
    }
    a {
      color: #0066cc;
    }
    th a {
      color: inherit;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    th a:hover,
    th a:focus {
      text-decoration: underline;
    }
    th a.sort-asc::after {
      content: '\25B2';
      font-size: 0.75em;
    }
    th a.sort-desc::after {
      content: '\25BC';
      font-size: 0.75em;
    }
    .summary {
      background: #f7f7f7;
      border-radius: 6px;
      border: 1px solid #ddd;
      padding: 16px;
      margin-top: 20px;
      max-width: 900px;
    }
    .category-Type2Diabetes {
      color: #b22222;
      font-weight: bold;
    }
    .category-Prediabetes {
      color: #cc7a00;
      font-weight: bold;
    }
    .category-Nondiabetic {
      color: #0a7d3c;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>CGMacros Participants</h1>
  <p class="description">
    Browse the participant bios below. Click a participant ID to view a detailed summary or
    follow the link to jump directly to the continuous glucose monitor data.
  </p>

  <table id="bioTable">
    <thead>
      <tr>
        <th><a href="#" data-sort="participant">Participant</a></th>
        <th><a href="#" data-sort="age">Age</a></th>
        <th><a href="#" data-sort="gender">Gender</a></th>
        <th><a href="#" data-sort="bmi">BMI</a></th>
        <th><a href="#" data-sort="a1c">A1c</a></th>
        <th><a href="#" data-sort="category">Category</a></th>
        <th>CGM Data</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="summaryContainer"></div>

  <footer style="margin-top:40px; font-size:0.9em; max-width:900px;">
    <h3>Citation</h3>
    <p>
      Gutierrez-Osuna, R., Kerr, D., Mortazavi, B., &amp; Das, A. (2025).
      <em>CGMacros: a scientific dataset for personalized nutrition and diet monitoring</em> (v1.0.0).
      PhysioNet. RRID: SCR_007345.
      <a href="https://doi.org/10.13026/3z8q-x658" target="_blank">https://doi.org/10.13026/3z8q-x658</a>
    </p>
    <p>
      Anurag Das, David Kerr, Namino Glanz, Wendy Bevier, Rony Santiago, Ricardo Gutierrez-Osuna, and Bobak Mortazavi.
      "<em>CGMacros: a scientific dataset for personalized nutrition and diet monitoring.</em>"
      <em>Scientific Data</em> (under review).
    </p>
    <p>
      Goldberger A., Amaral L., Glass L., Hausdorff J., Ivanov P. C., Mark R., … &amp; Stanley H. E. (2000).
      <em>PhysioBank, PhysioToolkit, and PhysioNet: Components of a new research resource for complex physiologic signals.</em>
      <em>Circulation</em> 101 (23): e215–e220. RRID: SCR_007345.
    </p>
    <p>
      <strong>License:</strong> Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)
    </p>
  </footer>

  <script>
    const biosFile = 'bio.csv';
    let biosData = [];
    const sortConfig = {
      participant: { key: 'subject', type: 'number' },
      age: { key: 'Age', type: 'number' },
      gender: { key: 'Gender', type: 'string' },
      bmi: { key: 'BMI', type: 'number' },
      a1c: { key: 'A1c PDL (Lab)', type: 'number' },
      category: {
        key: 'categoryLabel',
        type: 'string',
        getter: row => determineCategory(row['A1c PDL (Lab)']).label
      }
    };
    const currentSort = {
      column: 'participant',
      direction: 'asc'
    };
    const params = new URLSearchParams(window.location.search);
    const initialPid = params.get('pid');

    Papa.parse(biosFile, {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function(results) {
        biosData = results.data.filter(row => row.subject);
        applySort('participant', false);
        if (initialPid) {
          const normalizedPid = String(initialPid).padStart(3, '0');
          showSummary(normalizedPid);
        }
      }
    });

    document.querySelectorAll('th a[data-sort]').forEach(link => {
      link.addEventListener('click', event => {
        event.preventDefault();
        const column = event.currentTarget.getAttribute('data-sort');
        applySort(column, true);
      });
    });

    function determineCategory(a1c) {
      const categoryKey = a1c >= 6.5 ? 'Type2Diabetes' :
                          a1c >= 5.7 ? 'Prediabetes' :
                          'Nondiabetic';
      const categoryLabel =
        categoryKey === 'Type2Diabetes' ? 'Type 2 Diabetes' :
        categoryKey === 'Prediabetes' ? 'Prediabetes' :
        'Non-diabetic';
      return { key: categoryKey, label: categoryLabel };
    }

    function applySort(column, toggleDirection = true) {
      if (!sortConfig[column] || biosData.length === 0) return;

      if (toggleDirection) {
        if (currentSort.column === column) {
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.column = column;
          currentSort.direction = 'asc';
        }
      } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
      }

      const sorted = [...biosData].sort((a, b) => compareRows(a, b, column));
      renderTable(sorted);
      updateSortIndicators();
    }

    function compareRows(a, b, column) {
      const config = sortConfig[column];
      const directionMultiplier = currentSort.direction === 'asc' ? 1 : -1;
      const rawA = config.getter ? config.getter(a) : a[config.key];
      const rawB = config.getter ? config.getter(b) : b[config.key];

      if (config.type === 'number') {
        const numA = Number(rawA);
        const numB = Number(rawB);
        if (Number.isNaN(numA) && Number.isNaN(numB)) return 0;
        if (Number.isNaN(numA)) return 1 * directionMultiplier;
        if (Number.isNaN(numB)) return -1 * directionMultiplier;
        return (numA - numB) * directionMultiplier;
      }

      const strA = rawA == null ? '' : String(rawA);
      const strB = rawB == null ? '' : String(rawB);
      return strA.localeCompare(strB, undefined, { sensitivity: 'base' }) * directionMultiplier;
    }

    function updateSortIndicators() {
      document.querySelectorAll('th a[data-sort]').forEach(link => {
        const column = link.getAttribute('data-sort');
        link.classList.remove('sort-asc', 'sort-desc');
        if (column === currentSort.column) {
          link.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
    }

    function renderTable(data) {
      const tbody = document.querySelector('#bioTable tbody');
      tbody.innerHTML = '';

      data.forEach(bio => {
        const a1c = bio['A1c PDL (Lab)'];
        const paddedSubject = String(bio.subject).padStart(3, '0');
        const { key: categoryKey, label: categoryLabel } = determineCategory(a1c);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><a class="participantLink" href="?pid=${paddedSubject}" data-pid="${paddedSubject}">${paddedSubject}</a></td>
          <td>${bio.Age}</td>
          <td>${bio.Gender}</td>
          <td>${Number(bio.BMI).toFixed(1)}</td>
          <td>${a1c}</td>
          <td class="category-${categoryKey}">${categoryLabel}</td>
          <td><a class="viewLink" href="index.html?pid=${paddedSubject}">View CGM Data</a></td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll('.participantLink').forEach(link => {
        link.addEventListener('click', event => {
          event.preventDefault();
          const pid = event.currentTarget.getAttribute('data-pid');
          showSummary(pid);
          const url = new URL(window.location);
          url.searchParams.set('pid', pid);
          history.replaceState(null, '', url);
        });
      });
    }

    function showSummary(id) {
      const bio = biosData.find(b => b.subject == id);
      if (!bio) return;

      const a1c = bio['A1c PDL (Lab)'];
      const { label: categoryLabel } = determineCategory(a1c);
      const paddedId = String(bio.subject).padStart(3, '0');
      const url = new URL(window.location);
      url.searchParams.set('pid', paddedId);
      history.replaceState(null, '', url);

      const summary = `
        <strong>Participant ${paddedId}</strong> is a ${bio.Age} y.o. ${bio['Self-identify ']}
        ${bio.Gender === 'M' ? 'male' : 'female'} with an A1c of ${a1c}% (${categoryLabel}) and a BMI of ${Number(bio.BMI).toFixed(1)}.
        <br><br>
        <strong>Measurements</strong><br>
        Height: ${bio['Height ']} in<br>
        Weight: ${bio['Body weight ']} lbs<br>
        BMI: ${Number(bio.BMI).toFixed(1)}<br><br>
        <strong>Blood Analytics</strong><br>
        HbA1c: ${a1c}%<br>
        Fasting Glucose: ${bio['Fasting GLU - PDL (Lab)']} mg/dL<br>
        Fasting Insulin: ${bio['Insulin ']} µIU/mL<br>
        Cholesterol, Total: ${bio.Cholesterol} mg/dL<br>
        Triglycerides: ${bio.Triglycerides} mg/dL<br>
        HDL: ${bio.HDL} mg/dL<br>
        LDL (Calculated): ${bio['LDL (Cal)']} mg/dL<br><br>
        <a class="viewLink" href="index.html?pid=${paddedId}">View CGM Data for this participant</a>.
      `;

      const container = document.getElementById('summaryContainer');
      container.innerHTML = `<div class="summary" id="summary-${paddedId}">${summary}</div>`;
      const summaryDiv = document.getElementById(`summary-${paddedId}`);
      summaryDiv.style.display = 'block';
      window.scrollTo({ top: summaryDiv.offsetTop - 20, behavior: 'smooth' });
    }
  </script>
</body>
</html>
